src/ └── order_management_system/ ├── base_types/ │ └── types.py # Canonical Types, Async Event/Command Definitions (with Priority attribute) ├── base_interfaces/ │ └── interfaces.py # Async Broker/DB interfaces ├── base_events/ │ └── events.py # Single file for P0, P1, P2 event definitions │ ├── database/ │ └── async_db_client.py # Async Database Driver (e.g., asyncpg, aiomysql) │ ├── core/ │ └── engine_task_orchestrator.py # Non-blocking core logic; delegates work │ ├── event_processors/ │ ├── order_state_worker.py # Order ID Hash-based worker for sequential state transitions (Deterministic) │ ├── greeks_executor.py # CPU-bound logic, run in ProcessPoolExecutor │ └── reconciliation_task.py # Scheduled async task for state verification │ ├── safety/ │ ├── risk_check_task.py # Async pre-processor risk checks (P0 Priority) │ └── kill_switch_service.py # Global async service to halt trading │ ├── connection/ │ └── broker_connection_task.py # Async task to monitor health and emit P1 events │ ├── brokers/ │ ├── ibkr/ │ │ ├── async_adapter.py # Wraps/implements non-blocking I/O to broker │ │ └── config.py │ └── dummy/ │ └── async_adapter.py # Simulation of non-blocking I/O │ ├── queue/ │ └── reactor.py # Asyncio Event Loop & PriorityQueue implementation │ ├── ops/ │ └── runbook.md │ └── tests/ ├── conftest.py │ ├── unit/ │ # ... (Existing unit tests) ... │ ├── test_async_priority_queue.py │ ├── test_order_state_worker.py # CRITICAL: Tests sequential consistency │ └── test_async_db_client.py │ ├── integration/ │ # ... (Existing integration tests) ... │ └── test_async_adapter_io.py # Tests I/O isolation/non-blocking behavior │ └── stress/ # ... (Existing stress tests) ... └── test_out_of_sequence_event_handling.py # CRITICAL: Stress test for deterministic processing # OMS Test Scenario Index This document maps every **risk scenario** to: - **Layer**: unit / integration / stress / regression - **Test file**: where it lives under tests/oms_tests/ - **Test name**: suggested function name The goal: If a scenario exists here but has no test → you are NOT done. --- ## 1. Connection & Heartbeat Scenarios (CONN-xx, HEART-xx) | Code | Name | Layer | Test File | Suggested Test Function | |----------|----------------------------------|-------------|-----------------------------------------------------|----------------------------------------------------------------| | CONN-01 | Mid-Submit Disconnect | integration | integration/test_engine_with_dummy_broker.py | test_mid_submit_disconnect_keeps_order_new_and_reconciles | | CONN-02 | Orphan Fill on Startup | integration | integration/test_reconciliation_end_to_end.py | test_orphan_fill_on_startup_creates_recovered_orderstate | | CONN-03 | Stale Working Order | integration | integration/test_engine_with_dummy_broker.py | test_stale_working_order_triggers_openorders_reconcile | | CONN-04 | Double Connect Same clientId | integration | integration/test_dummy_broker_edge_cases.py | test_double_connect_same_clientid_shuts_down_first_process | | CONN-05 | TWS Clock Skew > 30s | unit | unit/test_state_machine.py | test_time_skew_normalizes_to_broker_time | | HEART-01 | No Events for 60s (heartbeat) | integration | integration/test_engine_with_dummy_broker.py | test_heartbeat_failure_blocks_new_submissions_and_alerts | --- ## 2. Lifecycle & Fill Handling (LIFE-xx) | Code | Name | Layer | Test File | Suggested Test Function | |---------|-------------------------------------|------------|-----------------------------------------|---------------------------------------------------------------------------| | LIFE-01 | Cancel Already Filled | unit | unit/test_state_machine.py | test_cancel_already_filled_is_ignored | | LIFE-02 | Cancel Rejected (“already canceled”)| unit | unit/test_state_machine.py | test_cancel_redundant_sets_canceled_broker_wins | | LIFE-03 | Fill After Cancelled | unit | unit/test_state_machine.py | test_fill_after_cancel_is_accepted_and_status_filled | | LIFE-04 | VWAP across 10 partial fills | unit | unit/test_state_machine.py | test_vwap_across_multiple_partial_fills_exact | | LIFE-05 | Duplicate execDetails | unit | unit/test_state_machine.py | test_duplicate_execdetails_ignored_by_execution_id | | LIFE-06 | Zero-Quantity Fill | unit | unit/test_state_machine.py | test_zero_quantity_fill_is_ignored | --- ## 3. Safety, Flatten, and Risk (FAIL-xx, SAFETY-xx, FAIL-08) | Code | Name | Layer | Test File | Suggested Test Function | |-----------|-----------------------------------------|-------------|-----------------------------------------|-------------------------------------------------------------------------| | FAIL-01 | Flatten-All During Frozen Market | integration | integration/test_engine_with_dummy_broker.py | test_flatten_all_rejected_in_frozen_market_logs_and_alerts | | FAIL-02 | Partial Flatten Rejection (margin) | integration | integration/test_engine_with_dummy_broker.py | test_partial_flatten_rejection_reports_unclosed_positions | | FAIL-03 | Flatten-All Recursion | unit | unit/test_safety.py | test_flatten_recursion_prevented_by_flatten_flag | | FAIL-04 | Broker Wins on Reconcile | integration | integration/test_reconciliation_end_to_end.py | test_reconcile_broker_wins_on_missing_order_marks_canceled | | FAIL-05 | OrderId Reuse After Midnight | unit | unit/test_state_machine.py | test_orderid_reuse_uses_permid_as_primary_key | | FAIL-06 | GTC Order Survives Weekend | integration | integration/test_reconciliation_end_to_end.py | test_gtc_order_recovered_after_weekend_reconcile | | FAIL-07 | Margin Call During Flatten | unit | unit/test_safety.py | test_flatten_aborted_on_margin_violation_and_alerted | | FAIL-08 | Flatten Order Filled After EOD | integration | integration/test_engine_with_dummy_broker.py | test_post_eod_flatten_fill_marked_post_market_and_alerted | | SAFETY-01 | Duplicate Intent Detection | unit | unit/test_safety.py | test_duplicate_intent_rejected_within_time_window | | SAFETY-02 | Max Orders Per Second | unit | unit/test_safety.py | test_max_orders_per_second_queues_and_throttles | | SAFETY-03 | Max Position Size | unit | unit/test_safety.py | test_position_limit_rejects_oversized_order | | SAFETY-04 | Daily Loss Circuit Breaker | unit | unit/test_safety.py | test_daily_loss_circuit_breaker_halts_trading | --- ## 4. Boundary / Architecture Contracts (BOUNDARY-xx, EVENT-ORDER, RECONCILE-RACE) These are **meta-safety**: enforce architecture, not fills. | Code | Name | Layer | Test File | Suggested Test Function | |--------------|-------------------------------------------|------------|----------------------------------------|------------------------------------------------------------------| | BOUNDARY-01 | Connector Mutates OrderState Directly | unit | unit/test_state_machine.py | test_connector_cannot_mutate_orderstate_directly | | BOUNDARY-02 | Engine Calls Connector Directly | unit | unit/test_safety.py or unit/test_event_definitions.py | test_engine_never_calls_broker_api_directly | | EVENT-ORDER | Two threads call submit() same microsecond| stress | stress/test_high_volume_orders.py | test_concurrent_submit_uses_single_writer_and_consistent_ids | | RECONCILE-RACE | Reconcile vs Fill at same ms | stress | stress/test_crash_recovery.py | test_reconcile_vs_fill_race_resolves_consistently | --- ## 5. Performance & Rate Limit (PERF-xx, RATE-01, EDGE-04) | Code | Name | Layer | Test File | Suggested Test Function | |----------|---------------------------|---------|--------------------------------------|--------------------------------------------------------------------| | PERF-01 | 10,000 Open Orders | stress | stress/test_high_volume_orders.py | test_ten_thousand_open_orders_memory_and_speed_ok | | PERF-02 | 100 fills/second | stress | stress/test_high_volume_orders.py | test_hundred_fills_per_second_no_backlog | | RATE-01 | IBKR 50 orders/sec limit | unit | unit/test_safety.py | test_rate_limit_50_orders_per_second_throttles_extra | | EDGE-04 | API Rate Limit 200/sec | stress | stress/test_high_volume_orders.py | test_api_rate_limit_queues_and_throttles_without_disconnect | --- ## 6. Security & Account Integrity (SEC-xx, ACCOUNT-PNL-DRIFT) | Code | Name | Layer | Test File | Suggested Test Function | |---------------|-----------------------------------|------------|----------------------------------------|-----------------------------------------------------------------| | SEC-01 | clientId=0 (shared UI) | integration | integration/test_dummy_broker_edge_cases.py | test_foreign_orders_detected_and_ignored | | SEC-02 | Account Switch Mid-Session | integration | integration/test_dummy_broker_edge_cases.py | test_account_switch_mismatch_triggers_shutdown | | ACCOUNT-PNL-DRIFT | Commission Currency Drift | unit | unit/test_state_machine.py or unit/test_pnl.py | test_commission_currency_conversion_prevents_pnl_drift | --- ## 7. Ops, Health, Logging (OPS-xx, OPS/health, REPLAY-01) | Code | Name | Layer | Test File | Suggested Test Function | |----------|-----------------------------|------------|----------------------------------------|------------------------------------------------------------------| | OPS-01 | Log Rotation & File Lock | integration | integration/test_ops_log_rotation.py | test_log_rotation_does_not_crash_or_block_engine | | OPS-02 | Health Endpoint Lies | integration | integration/test_ops_health_checks.py| test_health_endpoint_includes_position_sanity_check | | REPLAY-01| Replay Log File | integration | integration/test_replay_from_log.py | test_replay_from_log_reconstructs_state_exactly | > **Note:** those ops tests correspond to code under ops/health_checks.py and your logging setup. --- ## 8. Edge Cases (EDGE-xx, TIME-DRIFT, PERMID-MISMATCH, SNAPSHOT-DIVERGENCE) | Code | Name | Layer | Test File | Suggested Test Function | |-------------------|---------------------------------|----------|-----------------------------------------|-------------------------------------------------------------------------| | EDGE-01 | Negative Price Fill | unit | unit/test_state_machine.py | test_negative_price_fill_is_rejected_and_alerted | | EDGE-02 | Symbol Change (corp action) | integration| integration/test_reconciliation_end_to_end.py | test_symbol_change_marks_old_orders_canceled | | EDGE-03 | OrderId Wrap-Around | unit | unit/test_state_machine.py | test_orderid_wrap_around_switches_to_permid_mapping | | TIME-DRIFT | Server Clock Jump 30s | unit | unit/test_state_machine.py | test_event_time_drift_uses_broker_time_for_pnl_and_vwap | | PERMID-MISMATCH | permId Changes Mid-Order | integration| integration/test_dummy_broker_edge_cases.py | test_permid_change_mid_order_retains_correct_tracking | | SNAPSHOT-DIVERGENCE| Snapshot vs replay mismatch | stress | stress/test_crash_recovery.py | test_snapshot_plus_tail_events_equals_full_replay | --- ## 9. Persistence & Crash Safety (PERSIST-xx, PARTIAL-WRITE) | Code | Name | Layer | Test File | Suggested Test Function | |--------------|--------------------------------|---------|--------------------------------------|------------------------------------------------------------------------| | PERSIST-01 | Crash & Restore | stress | stress/test_crash_recovery.py | test_crash_and_restore_has_no_phantom_positions | | PERSIST-02 | Partial Write Recovery | stress | stress/test_crash_recovery.py | test_partial_write_detected_and_recovered_from_backup_or_reconcile | | PARTIAL-WRITE| Half-written JSON/event | unit | unit/test_database_transactions.py | test_partial_write_causes_replay_recovery_strategy_not_crash | --- ## 10. Modify/Replace Semantics (MODIFY-xx) | Code | Name | Layer | Test File | Suggested Test Function | |-----------|---------------------------|---------|----------------------------------|-------------------------------------------------------------------| | MODIFY-01 | Replace Limit Price | unit | unit/test_state_machine.py | test_replace_limit_price_preserves_fills_and_oms_id | | MODIFY-02 | Reduce Quantity | unit | unit/test_state_machine.py | test_reduce_quantity_preserves_filled_qty_and_updates_remaining| --- ## 11. PnL & Exposure (PNL-xx) | Code | Name | Layer | Test File | Suggested Test Function | |--------|---------------------------|--------|------------------------|----------------------------------------------------------------| | PNL-01 | Realized PnL After Close | unit | unit/test_state_machine.py or unit/test_pnl.py | test_realized_pnl_on_close_correct | | PNL-02 | Unrealized PnL Drift | unit | unit/test_pnl.py | test_unrealized_pnl_updates_on_price_change | --- ## 12. Routing & Multi-Broker (ROUTE-01) | Code | Name | Layer | Test File | Suggested Test Function | |---------|-------------------------|-------------|--------------------------------------------|---------------------------------------------------------| | ROUTE-01| Route to Webull if down| integration | integration/test_routing_broker.py | test_ibkr_down_routes_to_secondary_broker | --- ## 13. Misc High-Risk Scenarios | Code | Name | Layer | Test File | Suggested Test Function | |-----------------|-------------------------------|--------|-----------------------------------|-------------------------------------------------------------------| | FLATTEN-DURING-FLATTEN | Flatten while flatten running | unit | unit/test_safety.py | test_flatten_during_flatten_does_not_recurse | --- # Implementation Notes - **Unit tests**: Focus on state_machine, safety, pnl, order_processor, reconciliation_processor. - **Integration tests**: Use DummyAdapter and your real ExecutionEngine + DB stack. - **Stress tests**: Simulate randomness, high volume, and repeated crash/restart cycles. - **Regression tests**: Every serious bug you hit in paper/live → it gets a permanent test in regression/. If a scenario above has **no corresponding test yet**, you are **not allowed** to claim the OMS is production-safe for that failure mode. ---